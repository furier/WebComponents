<link rel="import" href="../../bower_components/polymer/polymer.html"/>

<polymer-element name="ss-list-group" attributes="items filtertext navigable">
    <template>

        <!--STYLING / CSS-->
        <link rel="stylesheet" href="../../bower_components/bootstrap/dist/css/bootstrap.min.css">

        <!--SEMANTICS-->
        <ul id="listGroup" class="list-group">
            <template repeat="{{item in items | filterItems(filtertext)}}">
                <li id="item" class="list-group-item {{item.type}} {{{active: item.selected} | tokenList}}">
                    {{item.text}}
                </li>
            </template>
        </ul>

    </template>
    <script>
        (function () {

            function _filterItems(items, callback) {
                if (!items) return [];
                var matches = [];
                for (var i = 0; i < items.length; i++) {
                    if (callback(items[i]))
                        matches.push(items[i]);
                }
                return matches;
            }

            function _contains(list, exp) {
                return list.indexOf(exp) > -1;
            }

            function _setNextIndex(self) {
                if (self.selectedIndex === null) throw new Error('ss-list-group: set attribute navigable="true" to be able to set selected index, ' +
                                                                 'and then use the selectIndex(index) method to select an initial index before trying to select next index.');
                var i = self.selectedIndex;
                var ic = self.items.length;
                if (i < ic - 1)
                    self.selectedIndex++;
                else
                    self.selectedIndex = 0;

                return {
                    oldIndex: i,
                    newIndex: self.selectedIndex
                }
            }

            function _setPrevIndex(self) {
                if (self.selectedIndex === null) throw new Error('ss-list-group: set attribute navigable="true" to be able to set selected index, ' +
                                                                 'and then use the selectIndex(index) method to select an initial index before trying to select previous index.');
                var i = self.selectedIndex;
                var ic = self.items.length;
                if (i > 0)
                    self.selectedIndex--;
                else
                    self.selectedIndex = ic - 1;

                return {
                    oldIndex: i,
                    newIndex: self.selectedIndex
                }
            }

            function _selectIndex(self, list, index) {
                self.selectedIndex = index;
                self.items.forEach(function (item) {
                    item.selected = false;
                });
                var selectedItem = list[index];
                selectedItem.selected = true;
                self.selecteditem = selectedItem;
            }

            Polymer({
                publish: {
                    selecteditem: {
                        value: null,
                        reflect: true
                    }
                },
                ready: function() {
                    // Sometimes the {{items}} passed in is a JSON string and not an Array Object,
                    // in those cases we just parse it as JSON to make it an Array Object.
                    this.items = typeof this.items === 'string' ? JSON.parse(this.items) : this.items || [];
                },
                filterItems: function (items, filterText) {
                    if (!filterText) return items;
                    if (!items) return [];

                    // Filter values
                    var filteredItems = _filterItems(items, function (item) {
                        // If its an exact match we don't want to show that one as a suggestion.
                        return item.text === filterText ? false : _contains(item.text, filterText);
                    });

                    if (this.navigable && !_contains(filteredItems, this.selecteditem)) {
                        _selectIndex(this, filteredItems, 0);
                    }

                    return  filteredItems;
                },
                selectIndex: function (index) {
                    if (!this.navigable) throw new Error('ss-list-group: set attribute navigable="true" to be able to set selected index.');
                    _selectIndex(this, this.items, index);
                },
                selectNext: function () {
                    if (!this.navigable) throw new Error('ss-list-group: set attribute navigable="true" to be able to select next index.');
                    var result = _setNextIndex(this);
                    this.items[result.oldIndex].selected = false;
                    var selectedItem = this.items[result.newIndex];
                    selectedItem.selected = true;
                    this.selecteditem = selectedItem;
                },
                selectPrev: function () {
                    if (!this.navigable) throw new Error('ss-list-group: set attribute navigable="true" to be able to select previous index.');
                    var result = _setPrevIndex(this);
                    this.items[result.oldIndex].selected = false;
                    var selectedItem = this.items[result.newIndex];
                    selectedItem.selected = true;
                    this.selecteditem = selectedItem;
                }
            });
        }());
    </script>
</polymer-element>